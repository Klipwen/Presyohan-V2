Here are the updates to implement the requested changes for the side navigation header.

1. Update app/build.gradle.kts
First, add the Coil dependency. This is the industry-standard library for loading images (like profile pictures) from URLs in Android Kotlin apps.

Kotlin

dependencies {
    // ... existing dependencies ...

    // Add this line for Image Loading (Coil)
    implementation("io.coil-kt:coil:2.6.0")
    
    // ... rest of dependencies
}
2. Update SupabaseAuthService.kt
We need to update the AppUserRow data class to retrieve the avatar_url from your database. We also update the getUserProfile function to look for the avatar in the user's metadata if it's not yet saved in the main table.

Kotlin

// ... existing imports ...
import kotlinx.serialization.json.JsonObject
import kotlinx.serialization.json.jsonPrimitive
import kotlinx.serialization.json.contentOrNull // Make sure this is imported

// ... inside SupabaseAuthService object ...

    // Fetch full profile for header display (name + user_code + avatar)
    suspend fun getUserProfile(): AppUserRow? = withContext(Dispatchers.IO) {
        val uid = client.auth.currentUserOrNull()?.id ?: return@withContext null
        return@withContext try {
            val rows = client.postgrest["app_users"].select {
                filter { eq("id", uid) }
                limit(1)
            }.decodeList<AppUserRow>()
            var row = rows.firstOrNull()

            // Get Metadata for fallback
            val metaAny: Any? = client.auth.currentUserOrNull()?.userMetadata
            val metaName = when (metaAny) {
                is Map<*, *> -> metaAny["name"] as? String
                is JsonObject -> metaAny["name"]?.jsonPrimitive?.contentOrNull
                else -> null
            }
            val metaAvatar = when (metaAny) {
                is Map<*, *> -> metaAny["avatar_url"] as? String
                is JsonObject -> metaAny["avatar_url"]?.jsonPrimitive?.contentOrNull
                else -> null
            }

            // Create row if missing, or update missing fields from metadata
            if (row == null) {
                row = AppUserRow(id = uid, name = metaName, avatar_url = metaAvatar)
            } else {
                if (row.name.isNullOrBlank() && !metaName.isNullOrBlank()) {
                    row = row.copy(name = metaName)
                }
                if (row.avatar_url.isNullOrBlank() && !metaAvatar.isNullOrBlank()) {
                    row = row.copy(avatar_url = metaAvatar)
                }
            }
            row
        } catch (e: Exception) { null }
    }

// ... at the bottom of the file, update the Data Class ...

@kotlinx.serialization.Serializable
data class AppUserRow(
    val id: String,
    val name: String? = null,
    val email: String? = null,
    val user_code: String? = null,
    val avatar_url: String? = null // Added this field
)
3. Update drawer_header.xml
I have replaced the standard ImageView with a ShapeableImageView to force a perfect circular crop, which looks more professional. I also removed the margins that might make it look off-center.

XML

<?xml version="1.0" encoding="utf-8"?>
<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:app="http://schemas.android.com/apk/res-auto"
    android:layout_width="match_parent"
    android:layout_height="wrap_content"
    android:orientation="vertical"
    android:gravity="center_vertical"
    android:background="#FFB703"
    android:padding="24dp">

    <com.google.android.material.image.ShapeableImageView
        android:id="@+id/drawerUserIcon"
        android:layout_width="72dp"
        android:layout_height="72dp"
        android:src="@drawable/icon_profile"
        android:background="@android:color/transparent"
        android:scaleType="centerCrop"
        android:contentDescription="User Icon"
        android:layout_gravity="center_horizontal"
        app:shapeAppearanceOverlay="@style/CircularImage"
        app:strokeWidth="2dp"
        app:strokeColor="@android:color/white" />

    <TextView
        android:id="@+id/drawerUserName"
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"
        android:text="User"
        android:textColor="@android:color/white"
        android:textSize="20sp"
        android:textStyle="bold"
        android:layout_marginTop="16dp"
        android:layout_gravity="center_horizontal" />

    <TextView
        android:id="@+id/drawerUserCode"
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"
        android:text="ID: --"
        android:textColor="@android:color/white"
        android:textSize="14sp"
        android:alpha="0.9"
        android:layout_marginTop="4dp"
        android:layout_gravity="center_horizontal" />

</LinearLayout>
Note: You need to add this style to your res/values/themes.xml (or styles.xml) for the circular crop to work:

XML

<style name="CircularImage" parent="">
    <item name="cornerFamily">rounded</item>
    <item name="cornerSize">50%</item>
</style>
4. Update HomeActivity.kt
Finally, update the updateDrawerHeader function to remove the email fallback and load the image using Coil.

Kotlin

// Add these imports at the top
import coil.load
import coil.transform.CircleCropTransformation
import com.google.android.material.imageview.ShapeableImageView
import androidx.core.content.ContextCompat

// ... inside HomeActivity class ...

    private fun updateDrawerHeader(navView: NavigationView) {
        val h = navView.getHeaderView(0)
        val uT = h.findViewById<TextView>(R.id.drawerUserName)
        val codeT = h.findViewById<TextView>(R.id.drawerUserCode)
        val img = h.findViewById<ShapeableImageView>(R.id.drawerUserIcon)

        // 1. Set Default State
        uT.text = "User" // Default name
        codeT?.visibility = View.GONE
        
        // Default placeholder tint (remove if image loads)
        img.setColorFilter(ContextCompat.getColor(this, R.color.white))

        lifecycleScope.launch {
            val profile = SupabaseAuthService.getUserProfile()
            
            if (profile != null) {
                // 2. Set Name (Strictly Name only, no email fallback)
                // If name is null, we keep "User" rather than showing an email
                if (!profile.name.isNullOrBlank()) {
                    uT.text = profile.name
                }

                // 3. Set User Code (ID)
                if (!profile.user_code.isNullOrBlank()) {
                    val formattedId = profile.user_code.uppercase()
                    codeT?.text = "ID: $formattedId"
                    codeT?.visibility = View.VISIBLE
                }

                // 4. Load Real Profile Image
                if (!profile.avatar_url.isNullOrBlank()) {
                    img.clearColorFilter() // Remove the white tint used for the icon
                    img.load(profile.avatar_url) {
                        crossfade(true)
                        transformations(CircleCropTransformation())
                        error(R.drawable.icon_profile) // Fallback if URL fails
                    }
                }
            } 
        }
    }
